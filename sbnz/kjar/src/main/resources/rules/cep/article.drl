package cep;

import com.ftn.sbnz.model.Filters;
import com.ftn.sbnz.model.RecommendedArticleDTO;
import com.ftn.sbnz.model.articles.Article;
import com.ftn.sbnz.model.articles.GrassFootbalShoe;
import com.ftn.sbnz.model.sport.Sport;
import com.ftn.sbnz.model.sport.SportLevel;
import com.ftn.sbnz.model.sport.SportTenisField;
import com.ftn.sbnz.model.articles.Ball;
import com.ftn.sbnz.model.articles.BallType;
import com.ftn.sbnz.model.articles.GearTypeFootball;
import com.ftn.sbnz.model.articles.FootballGear;
import com.ftn.sbnz.model.articles.FootbalShoeNoCrampons;
import com.ftn.sbnz.model.sport.SportFootballType;
import com.ftn.sbnz.model.events.Purchase;
import com.ftn.sbnz.model.articles.Rating;
import com.ftn.sbnz.model.articles.Barbel;
import com.ftn.sbnz.model.articles.BarbelType;
import com.ftn.sbnz.model.articles.Weight;
import com.ftn.sbnz.model.articles.WlTypeOfGear;
import com.ftn.sbnz.model.articles.WeightliftingGear;
import com.ftn.sbnz.model.sport.SportWeightliftingType;
import com.ftn.sbnz.model.articles.OrientiringGear;
import com.ftn.sbnz.model.articles.TypeOfOrientiringGear;
import com.ftn.sbnz.model.articles.Sweatpants;
import com.ftn.sbnz.model.articles.SweatpantsType;
import com.ftn.sbnz.model.articles.Racket;
import com.ftn.sbnz.model.users.Gender;
import com.ftn.sbnz.model.articles.ArticleGenderType;



import java.util.Set;
import java.util.List;

global Set<RecommendedArticleDTO> recommendations;

rule "Ukoliko je kupljen neki artikal u poslednjih mesec dana, ne preporucivati ga"
salience -1000
when
    $article: RecommendedArticleDTO($id: id) from recommendations
    $purchase : Purchase(article.getId() == $id) over window:time(30d)
then
    recommendations.remove($article);
end

rule "Ukoliko je brend ocenjen ispod 3 5 ili vise puta u poslednjih godinu dana ne preporucuj ga"
salience -100
when
    $article: RecommendedArticleDTO($brand: brandName) from recommendations
    Number(intValue >= 5) from accumulate(
    $rating:Rating(article.getBrandName() == $brand, rating <= 3)
    over window: time(365d),
    count($rating)
)
then
    System.out.println($article);
    recommendations.remove($article);
end

rule "Ukoliko je korisnik musko izbaci zenske artikle iz preporuke"
salience -100
when
    Filters(getGender() == Gender.Musko)
    $recommendedArticle: RecommendedArticleDTO($id: id) from recommendations
    $article: Article(id==$id, gender == ArticleGenderType.Female)
then
    System.out.println($article);
    recommendations.remove($article);
end

rule "Ukoliko je kupio preko 4 ploce od 20kg nudimo olimpijsku sipku"
salience 1000
when
    $article: Article()
    $proSipka: Barbel(type == BarbelType.Olimpijska) from $article
    $tezina: Weight($idWeight:id, weight > 19.9)
    Number(intValue >= 4) from accumulate(
    $purchase : Purchase(article.getId() == $idWeight)
    over window: time(365d),
    count($purchase)
)
then
    RecommendedArticleDTO recommendedArticle = new RecommendedArticleDTO();
    recommendedArticle.setName($article.getName());
    recommendedArticle.setPrice($article.getPrice());
    recommendedArticle.setId($article.getId());
    recommendedArticle.setBrandName($article.getBrandName());
    recommendedArticle.setArticleType("Olympic barbel");
    recommendedArticle.setPathToImage($article.getPathToImage());
    recommendations.add(recommendedArticle);
    insert(recommendedArticle);
    
end

rule "Ukoliko je kupio preko 4 ploce od 20kg i olimpijsku sipku i powerlifter je, nudimo mu kais za dizanje tegova"
salience 100
when
    $filters: Filters(sport == Sport.DizanjeTegova, typeOfWeightlifting == SportWeightliftingType.Powerlifting)
    $article: Article()
    $kais: WeightliftingGear(type == WlTypeOfGear.Belt) from $article
    Barbel($idSipka:id, type == BarbelType.Olimpijska)
    Purchase(article.getId() == $idSipka)
    $tezina: Weight($idWeight:id, weight > 19.9)
    Number(intValue >= 4) from accumulate(
    $purchase : Purchase(article.getId() == $idWeight)
    over window: time(365d),
    count($purchase)
)
then
    RecommendedArticleDTO recommendedArticle = new RecommendedArticleDTO();
    recommendedArticle.setName($article.getName());
    recommendedArticle.setPrice($article.getPrice());
    recommendedArticle.setId($article.getId());
    recommendedArticle.setBrandName($article.getBrandName());
    recommendedArticle.setArticleType("Belt");
    recommendedArticle.setPathToImage($article.getPathToImage());
    recommendations.add(recommendedArticle);
    insert(recommendedArticle);
    
end

rule "Ukoliko je kupio preko 4 ploce od 20kg i olimpijsku sipku i powerlifter je, nudimo mu steznike za kolena"
salience 100
when
    $filters: Filters(sport == Sport.DizanjeTegova, typeOfWeightlifting == SportWeightliftingType.Powerlifting)
    $article: Article()
    $kais: WeightliftingGear(type == WlTypeOfGear.KneeWrap) from $article
    Barbel($idSipka:id, type == BarbelType.Olimpijska)
    Purchase(article.getId() == $idSipka)
    $tezina: Weight($idWeight:id, weight > 19.9)
    Number(intValue >= 4) from accumulate(
    $purchase : Purchase(article.getId() == $idWeight)
    over window: time(365d),
    count($purchase)
)
then
    RecommendedArticleDTO recommendedArticle = new RecommendedArticleDTO();
    recommendedArticle.setName($article.getName());
    recommendedArticle.setPrice($article.getPrice());
    recommendedArticle.setId($article.getId());
    recommendedArticle.setBrandName($article.getBrandName());
    recommendedArticle.setArticleType("KneeWrap");
    recommendedArticle.setPathToImage($article.getPathToImage());
    recommendations.add(recommendedArticle);
    insert(recommendedArticle);
    
end

rule "Ukoliko se bavi orijentiringom i kupio je poludugacku trenerku u poslednjih 6 meseci preporucuju mu se kamasne"
salience 100
when
    $filters: Filters(sport == Sport.Orijentiring)
    $article: Article()
    $kamasne: OrientiringGear(type == TypeOfOrientiringGear.Kamasne) from $article
    Sweatpants($idPoludugacke:id, type == SweatpantsType.Poludugacko)
    Purchase(article.getId() == $idPoludugacke)
    over window: time(182d)

then
    RecommendedArticleDTO recommendedArticle = new RecommendedArticleDTO();
    recommendedArticle.setName($article.getName());
    recommendedArticle.setPrice($article.getPrice());
    recommendedArticle.setId($article.getId());
    recommendedArticle.setBrandName($article.getBrandName());
    recommendedArticle.setArticleType("Gaiters");
    recommendedArticle.setPathToImage($article.getPathToImage());
    recommendations.add(recommendedArticle);
    insert(recommendedArticle);
    
end

rule "Ukoliko se bavi orijentiringom i kupio je kamasne uposlednjih 6 meseci kratke carape"
salience 99
when
    $filters: Filters(sport == Sport.Orijentiring)
    $article: Article()
    $carape: OrientiringGear(type == TypeOfOrientiringGear.KratkeCarape) from $article
    OrientiringGear($idKamasne:id, type == TypeOfOrientiringGear.Kamasne)
    Purchase(article.getId() == $idKamasne)
    over window: time(182d)

then
    RecommendedArticleDTO recommendedArticle = new RecommendedArticleDTO();
    recommendedArticle.setName($article.getName());
    recommendedArticle.setPrice($article.getPrice());
    recommendedArticle.setId($article.getId());
    recommendedArticle.setBrandName($article.getBrandName());
    recommendedArticle.setArticleType("Short socks");
    recommendedArticle.setPathToImage($article.getPathToImage());
    recommendations.add(recommendedArticle);
    insert(recommendedArticle);
    
end

rule "Ukoliko je prosecna tezina kupljenih reketa veca nego u poslednje 3 godine, izbaci iz preporucenih rekete lakse od najlakseg reketa kupljenog pre 3 godine"
salience -50
when
    $filters: Filters(sport == Sport.Tenis)
    
    $avgLastYear:Number() from accumulate(
    $purchase : Purchase(article instanceof Racket, $racket: article)
    over window: time(365d),
    average(((Racket) $purchase.getArticle()).getWeight())
)
    $avgLast3Year:Number() from accumulate(
    $purchase : Purchase(article instanceof Racket, $racket: article)
    over window: time(1095d),
      average(((Racket) $purchase.getArticle()).getWeight())
)   
    eval($avgLastYear.doubleValue() > ($avgLast3Year.doubleValue()))

    $minLast3Year:Number() from accumulate(
    $purchase : Purchase(article instanceof Racket, $racket: article)
    over window: time(1095d),
    min(((Racket) $purchase.getArticle()).getWeight()))

    Number(intValue >= 1) from accumulate(
    $purchase : Purchase(article instanceof Racket, $racket: article)
    over window: time(365d),
    count($purchase)
    )
    Number(intValue >= 3) from accumulate(
    $purchase : Purchase(article instanceof Racket, $racket: article)
    over window: time(1095d),
    count($purchase)
    )
    Racket($id: id, getWeight() < $minLast3Year.floatValue())
    $articleRec: RecommendedArticleDTO(id == $id) from recommendations


then
     recommendations.remove($articleRec);
     
end


